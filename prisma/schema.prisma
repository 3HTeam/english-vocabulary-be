// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== CONTENT MODELS ====================

model Topic {
  id          String    @id @default(uuid())
  name        String    @unique
  imageUrl    String    @default("")
  slug        String    @unique
  description String?
  status      Boolean   @default(true)
  deletedAt   DateTime?
  isDeleted   Boolean   @default(false)
  createdBy   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  vocabularies Vocabulary[]
  exercises    Exercise[]
}

model Vocabulary {
  id          String    @id @default(uuid())
  word        String
  translation String?
  phonetic    String?
  imageUrl    String?
  audioUrlUs  String?
  audioUrlUk  String?
  audioUrlAu  String?
  status      Boolean   @default(true)
  deletedAt   DateTime?
  isDeleted   Boolean   @default(false)
  createdBy   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  topicId String
  topic   Topic  @relation(fields: [topicId], references: [id], onDelete: Restrict)

  meanings Meaning[]

  @@unique([topicId, word])
  @@index([topicId])
}

model Meaning {
  id           String       @id @default(uuid())
  vocabularyId String
  partOfSpeech PartOfSpeech
  synonyms     String[]     @default([])
  antonyms     String[]     @default([])

  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  vocabulary Vocabulary @relation(fields: [vocabularyId], references: [id], onDelete: Cascade)

  definitions Definition[]

  @@index([vocabularyId])
}

model Definition {
  id String @id @default(uuid())

  definition         String
  translation        String?
  example            String?
  exampleTranslation String?
  isDeleted          Boolean   @default(false)
  deletedAt          DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  meaningId String
  meaning   Meaning @relation(fields: [meaningId], references: [id], onDelete: Cascade)

  @@index([meaningId])
}

// ==================== USER & AUTH ====================

model User {
  id                       String    @id @default(uuid())
  email                    String    @unique
  password                 String
  fullName                 String?
  role                     Role      @default(USER)
  avatar                   String?
  phone                    String?
  emailVerified            Boolean   @default(false)
  emailVerificationOtp     String?
  emailVerificationExpires DateTime?
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt

  levelId     String?
  level       Level?  @relation(fields: [levelId], references: [id], onDelete: SetNull)
  targetLevel String?
  dailyGoal   Int?    @default(0)
  streak      Int     @default(0)

  grammarProgresses   UserGrammarProgress[]
  userExerciseAnswers UserExerciseAnswer[]
  userExams           UserExam[]
  devices             UserDevice[]

  @@index([levelId])
  @@index([email])
}

model UserDevice {
  id             String         @id @default(uuid())
  pushToken      String?        @unique
  pushTokenType  PushTokenType?
  deviceName     String?
  deviceModel    String?
  deviceBrand    String?
  platform       Platform
  osVersion      String?
  appVersion     String?
  appBuildNumber String?
  isActive       Boolean        @default(true)
  lastActiveAt   DateTime       @default(now())
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([pushToken])
  @@index([isActive])
}

model Level {
  id          String  @id @default(uuid())
  cefrLevel   String  @unique // "A1", "A2", "B1", "B2", "C1", "C2"
  name        String // "Beginner", "Elementary",...
  description String?

  // Thang điểm tương ứng
  toeicScoreMin Int?
  toeicScoreMax Int?
  ieltsMin      Float?
  ieltsMax      Float?

  order     Int       @unique
  status    Boolean   @default(true)
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  createdBy String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  users         User[]
  grammarTopics GrammarTopic[]
  exercises     Exercise[]
  exams         Exam[]

  @@index([cefrLevel])
  @@index([status])
}

// ==================== APP CONFIG ====================

model Setting {
  id             String   @id @default(uuid())
  appName        String   @default("English Vocabulary")
  appDescription String?
  logoUrl        String?
  faviconUrl     String?
  primaryColor   String   @default("#3B82F6")
  email          String?
  phone          String?
  address        String?
  facebook       String?
  twitter        String?
  instagram      String?
  youtube        String?
  tiktok         String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Onboarding {
  id          String    @id @default(uuid())
  title       String
  imageUrl    String?
  description String?
  status      Boolean   @default(true)
  isDeleted   Boolean   @default(false)
  deletedAt   DateTime?
  createdBy   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Module {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  status      Boolean   @default(true)
  isDeleted   Boolean   @default(false)
  deletedAt   DateTime?
  createdBy   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  popups  Popup[]
  banners Banner[]
}

model Popup {
  id          String    @id @default(uuid())
  title       String
  imageUrl    String?
  description String?
  status      Boolean   @default(true)
  isDeleted   Boolean   @default(false)
  deletedAt   DateTime?
  createdBy   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  moduleId String
  module   Module @relation(fields: [moduleId], references: [id], onDelete: Restrict)
}

model Banner {
  id          String    @id @default(uuid())
  title       String
  imageUrl    String?
  description String?
  status      Boolean   @default(true)
  isDeleted   Boolean   @default(false)
  deletedAt   DateTime?
  createdBy   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  moduleId String
  module   Module @relation(fields: [moduleId], references: [id], onDelete: Restrict)
}

// ==================== GRAMMAR ====================

model GrammarCategory {
  id          String    @id @default(uuid())
  name        String    @unique
  slug        String    @unique
  imageUrl    String?
  description String?
  status      Boolean   @default(true)
  isDeleted   Boolean   @default(false)
  deletedAt   DateTime?
  createdBy   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  grammarTopics GrammarTopic[]
}

model GrammarTopic {
  id          String     @id @default(uuid())
  title       String
  imageUrl    String?
  description String?
  slug        String     @unique
  content     String
  status      Boolean    @default(true)
  order       Int        @unique
  difficulty  Difficulty @default(BEGINNER)
  isDeleted   Boolean    @default(false)
  deletedAt   DateTime?
  createdBy   String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  levelId String
  level   Level  @relation(fields: [levelId], references: [id], onDelete: Restrict)

  grammarCategoryId String
  grammarCategory   GrammarCategory @relation(fields: [grammarCategoryId], references: [id], onDelete: Restrict)

  exercises         Exercise[]
  grammarProgresses UserGrammarProgress[]

  @@index([grammarCategoryId])
  @@index([levelId])
  @@index([status])
  @@index([difficulty])
}

// ==================== EXERCISE (Unified) ====================

model Exercise {
  id          String           @id @default(uuid())
  type        ExerciseType
  category    ExerciseCategory
  question    String
  explanation String?
  transcript  String? 
  content     String?
  mediaUrl    String?
  mediaType   MediaType?
  score       Int              @default(10)
  tags        String[]         @default([])
  metadata    Json?
  order       Int              @default(0)
  status      Boolean          @default(true)
  isDeleted   Boolean          @default(false)
  deletedAt   DateTime?
  createdBy   String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  levelId String
  level   Level  @relation(fields: [levelId], references: [id], onDelete: Restrict)

  grammarTopicId String?
  grammarTopic   GrammarTopic? @relation(fields: [grammarTopicId], references: [id], onDelete: Restrict)

  topicId String?
  topic   Topic?  @relation(fields: [topicId], references: [id], onDelete: Restrict)

  exerciseOptions     ExerciseOption[]
  userExerciseAnswers UserExerciseAnswer[]
  examQuestions       ExamQuestion[]

  @@index([levelId])
  @@index([grammarTopicId])
  @@index([topicId])
  @@index([category])
  @@index([type])
}

model ExerciseOption {
  id        String  @id @default(uuid())
  content   String // Nội dung đáp án
  isCorrect Boolean @default(false)
  order     Int     @default(0)
  metadata  Json? // Data đặc biệt (matchWith cho MATCHING,...)

  exerciseId String
  exercise   Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@index([exerciseId])
}

model UserExerciseAnswer {
  id        String   @id @default(uuid())
  answer    Json
  isCorrect Boolean  @default(false)
  timeSpent Int      @default(0)
  score     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Restrict)

  exerciseId String
  exercise   Exercise @relation(fields: [exerciseId], references: [id], onDelete: Restrict)

  @@index([userId])
  @@index([exerciseId])
  @@index([isCorrect])
}

// ==================== PROGRESS ====================

model UserGrammarProgress {
  id             String         @id @default(uuid())
  status         ProgressStatus @default(NOT_STARTED)
  progress       Int            @default(0)
  score          Float          @default(0)
  startAt        DateTime?
  completedAt    DateTime?
  lastAccessedAt DateTime       @default(now())
  totalTimeSpent Int            @default(0)
  attemptCount   Int            @default(0)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Restrict)

  grammarTopicId String
  grammarTopic   GrammarTopic @relation(fields: [grammarTopicId], references: [id], onDelete: Restrict)

  @@unique([userId, grammarTopicId])
  @@index([userId])
  @@index([grammarTopicId])
  @@index([status])
}

// ==================== EXAM (TOEIC / IELTS) ====================

model Exam {
  id             String    @id @default(uuid())
  title          String
  description    String?
  imageUrl       String?
  examType       ExamType
  duration       Int // tổng thời gian (phút)
  totalQuestions Int
  maxScore       Int // TOEIC: 990, IELTS: 9
  scoreType      ScoreType // NUMERIC hoặc BAND
  status         Boolean   @default(true)
  isDeleted      Boolean   @default(false)
  deletedAt      DateTime?
  createdBy      String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  levelId String
  level   Level  @relation(fields: [levelId], references: [id], onDelete: Restrict)

  sections  ExamSection[]
  userExams UserExam[]

  @@index([levelId])
  @@index([examType])
  @@index([status])
}

model ExamSection {
  id             String      @id @default(uuid())
  name           String
  sectionType    SectionType
  order          Int
  duration       Int?
  totalQuestions Int
  maxScore       Int

  examId String
  exam   Exam   @relation(fields: [examId], references: [id], onDelete: Cascade)

  examQuestions ExamQuestion[]

  @@unique([examId, order])
  @@index([examId])
}

model ExamQuestion {
  id    String @id @default(uuid())
  order Int

  examSectionId String
  examSection   ExamSection @relation(fields: [examSectionId], references: [id], onDelete: Cascade)

  exerciseId String
  exercise   Exercise @relation(fields: [exerciseId], references: [id], onDelete: Restrict)

  userExamAnswers UserExamAnswer[]

  @@unique([examSectionId, order])
  @@index([examSectionId])
  @@index([exerciseId])
}

model UserExam {
  id              String     @id @default(uuid())
  status          TestStatus @default(IN_PROGRESS)
  totalScore      Float      @default(0)
  maxScore        Float      @default(0)
  estimatedScore  Int?
  estimatedBand   Float?
  levelAssessment String?
  startedAt       DateTime   @default(now())
  completedAt     DateTime?
  timeSpent       Int        @default(0)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Restrict)

  examId String
  exam   Exam   @relation(fields: [examId], references: [id], onDelete: Restrict)

  userExamAnswers UserExamAnswer[]

  @@index([userId])
  @@index([examId])
  @@index([status])
}

model UserExamAnswer {
  id        String   @id @default(uuid())
  answer    Json
  isCorrect Boolean  @default(false)
  timeSpent Int      @default(0)
  score     Int      @default(0)
  createdAt DateTime @default(now())

  userExamId String
  userExam   UserExam @relation(fields: [userExamId], references: [id], onDelete: Cascade)

  examQuestionId String
  examQuestion   ExamQuestion @relation(fields: [examQuestionId], references: [id], onDelete: Restrict)

  @@index([userExamId])
  @@index([examQuestionId])
}

// ==================== ENUMS ====================

enum Difficulty {
  BEGINNER
  ELEMENTARY
  INTERMEDIATE
  UPPER_INTERMEDIATE
  ADVANCED
  PROFICIENT
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  REVIEWED
}

enum ExerciseType {
  MULTIPLE_CHOICE
  FILL_BLANK
  MATCHING
  TRUE_FALSE
  LISTENING
  SPEAKING
  WRITING
  ORDERING
}

enum ExerciseCategory {
  GRAMMAR
  VOCABULARY
  READING
  LISTENING
  PRONUNCIATION
}

enum Role {
  USER
  ADMIN
}

enum PartOfSpeech {
  noun
  verb
  adjective
  adverb
  pronoun
  preposition
  conjunction
  interjection
  determiner
  article
  numeral
  phrasal_verb
  idiom
  phrase
}

enum Platform {
  ios
  android
}

enum PushTokenType {
  expo
  fcm
  apns
}

enum ExamType {
  TOEIC
  IELTS
}

enum ScoreType {
  NUMERIC
  BAND
}

enum SectionType {
  LISTENING
  READING
  WRITING
  SPEAKING
}

enum MediaType {
  IMAGE
  AUDIO
  VIDEO
}

enum TestStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
  TIMED_OUT
}
